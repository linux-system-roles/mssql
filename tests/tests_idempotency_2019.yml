# SPDX-License-Identifier: MIT
---
- name: Ensure that the role is idempotent
  hosts: all
  vars:
    mssql_accept_microsoft_odbc_driver_17_for_sql_server_eula: true
    mssql_accept_microsoft_cli_utilities_for_sql_server_eula: true
    mssql_accept_microsoft_sql_server_standard_eula: true
  tasks:
    - name: Print time at the beginning of the test
      command: date +"%Y-%m-%d %H:%M:%S"
      register: __time1
      changed_when: false

    - name: Register dnf.conf
      stat:
        path: /etc/dnf/dnf.conf
      register: __dnf_conf

    - name: Print yum.conf or dnf.conf
      command: >-
        cat {{ '/etc/dnf/dnf.conf' if __dnf_conf.stat.exists
        else '/etc/yum.conf' }}
      changed_when: false

    - name: Remove proxy from dnf.conf or yum.conf
      lineinfile:
        path: >-
          {{ '/etc/dnf/dnf.conf' if __dnf_conf.stat.exists else
          '/etc/yum.conf' }}
        regexp: "{{ item }}"
        state: absent
      loop:
        - ^proxy
        - ^sslverify


    - name: Run on a fresh host and set all parameters
      include_role:
        name: linux-system-roles.mssql
      vars:
        mssql_password: "p@55w0rD"
        mssql_edition: Evaluation
        mssql_tcp_port: 1443
        mssql_ip_address: 0.0.0.0
        mssql_enable_sql_agent: true
        mssql_install_fts: true
        mssql_enable_ha: true
        mssql_tune_for_fua_storage: true

    - name: Configure the mssql-server service start limit interval and burst
      include_tasks: tasks/mssql-sever-increase-start-limit.yml

    - name: Flush handlers
      meta: flush_handlers

    - name: Run again with the same settings - should report not changed
      include_role:
        name: linux-system-roles.mssql
      vars:
        mssql_password: "p@55w0rD"
        mssql_edition: Evaluation
        mssql_tcp_port: 1443
        mssql_ip_address: 0.0.0.0
        mssql_enable_sql_agent: true
        mssql_install_fts: true
        mssql_enable_ha: true
        mssql_tune_for_fua_storage: true

    - name: Verify settings
      include_tasks: tasks/verify_settings.yml
      vars:
        __verify_mssql_password: "p@55w0rD"
        __verify_mssql_edition: Evaluation
        __verify_mssql_tcp_port: 1443
        __verify_mssql_ip_address: 0.0.0.0
        __verify_mssql_agent_is_enabled: true
        __verify_mssql_fts_is_installed: true
        __verify_mssql_ha_is_installed: true
        __verify_mssql_is_tuned_for_fua: true

    - name: Run to edit settings
      include_role:
        name: linux-system-roles.mssql
      vars:
        mssql_password: "p@55w0rd"
        mssql_edition: Standard
        mssql_tcp_port: 1442
        mssql_ip_address: 127.0.0.1
        mssql_enable_sql_agent: false
        mssql_install_fts: false
        mssql_enable_ha: false
        mssql_tune_for_fua_storage: false

    - name: Flush handlers
      meta: flush_handlers

    - name: Run with the edited settings again - should report not changed
      include_role:
        name: linux-system-roles.mssql
      vars:
        mssql_password: "p@55w0rd"
        mssql_edition: Standard
        mssql_tcp_port: 1442
        mssql_ip_address: 127.0.0.1
        mssql_enable_sql_agent: false
        mssql_install_fts: false
        mssql_enable_ha: false
        mssql_tune_for_fua_storage: false

    - name: Verify disabled settings
      include_tasks: tasks/verify_settings.yml
      vars:
        __verify_mssql_password: "p@55w0rd"
        __verify_mssql_edition: Standard
        __verify_mssql_tcp_port: 1442
        __verify_mssql_ip_address: 127.0.0.1
        __verify_mssql_agent_is_enabled: false
        __verify_mssql_fts_is_installed: false
        __verify_mssql_ha_is_installed: false
        __verify_mssql_is_tuned_for_fua: false

    - name: Print time at the end of the test
      command: date +"%Y-%m-%d %H:%M:%S"
      register: __time2
      changed_when: false

    - name: Print resulting time
      debug:
        msg: >-
          The test took {{ __time2.stdout | to_datetime -
          __time1.stdout | to_datetime }}
