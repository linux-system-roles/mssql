---
- name: Ensure ansible_facts to get ansible_distribution
  setup:
    gather_subset: min

- name: Assert fail on EL 7 with version = 2022 and EL 9 with version != 2022
  when: >-
    (ansible_distribution in ['CentOS', 'RedHat'] and
    ansible_distribution_major_version is version('7', '=') and
    mssql_version | int == 2022) or
    (ansible_distribution in ['CentOS', 'RedHat'] and
    ansible_distribution_major_version is version('9', '=') and
    mssql_version | int != 2022)
  block:
    - name: Run the role
      vars:
        mssql_password: "p@55w0rD"
        mssql_edition: Evaluation
      include_role:
        name: linux-system-roles.mssql

    - name: Unreachable task
      fail:
        msg: The above task must fail
  rescue:
    - name: Assert that the role failed with EL < 8 not supported
      assert:
        that: >-
          'You must set the mssql_version variable to one of'
          in ansible_failed_result.msg

    - name: Clean up after the role invocation
      include_tasks: tasks/cleanup.yml

    # Putting end_host into a rescue block results in a failed task
    - name: End EL < 8 host
      meta: end_host
