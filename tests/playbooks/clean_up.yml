---
- name: Purge cluster and mssql configuration
  hosts: all
  tasks:
    - name: Purge cluster configuration
      vars:
        ha_cluster_cluster_present: false
        ha_cluster_enable_repos: false
      include_role:
        name: fedora.linux_system_roles.ha_cluster

    - name: Purge firewall configuration
      vars:
        firewall:
          - previous: replaced
      include_role:
        name: fedora.linux_system_roles.firewall

    - name: Leave realm  # noqa no-changed-when
      command: realm leave
      register: realm_leave
      failed_when: >-
        not "Couldn't find a configured realm" in realm_leave.stderr

    - name: Destroy Kerberos tickets  # noqa no-changed-when
      command: kdestroy -A

    - name: Remove related packages
      package:
        name:
          - mssql-server
          - adutil
        state: absent

    - name: Remove related files
      # noqa deprecated-command-syntax
      shell: >-
        rm -rf /var/opt/mssql
        /opt/mssql
        /tmp/ansible.*
        /var/log/pacemaker/pacemaker.log
        /etc/yum.repos.d/packages-microsoft-com-*
      changed_when: true
