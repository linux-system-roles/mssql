# SPDX-License-Identifier: MIT
---
- name: Ensure that the role runs with default parameters
  hosts: all
  tasks:
    - name: Print time at the beginning of the test
      command: date +"%Y-%m-%d %H:%M:%S"
      register: __time1
      changed_when: false

    - name: Register dnf.conf
      stat:
        path: /etc/dnf/dnf.conf
      register: __dnf_conf

    - name: Remove proxy from dnf.conf or yum.conf
      lineinfile:
        path: >-
          {{ "/etc/dnf/dnf.conf" if __dnf_conf.stat.exists else
          "/etc/yum.conf" }}
        regexp: "{{ item }}"
        state: absent
      loop:
        - ^proxy
        - ^sslverify


    - name: Verify that by default the role fails with EULA not accepted
      block:
        - name: Run the role with default parameters
          include_role:
            name: linux-system-roles.mssql

        - name: Unreachable task
          fail:
            msg: The above task must fail

      rescue:
        - name: Assert that the role failed with EULA not accepted
          assert:
            that: >-
              'You must accept EULA' in ansible_failed_result.msg.0

    - name: Print time at the end of the test
      command: date +"%Y-%m-%d %H:%M:%S"
      register: __time2
      changed_when: false

    - name: Print resulting time
      debug:
        msg: >-
          The test took {{ __time2.stdout | to_datetime -
          __time1.stdout | to_datetime }}
